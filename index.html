<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR メモ デバッグ版</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; }
        #canvas-container { width: 100%; height: 100vh; position: relative; }
        #info { position: absolute; top: 20px; left: 20px; background: rgba(0,0,0,0.9); padding: 20px; border-radius: 8px; z-index: 100; max-width: 400px; }
        #info h2 { margin-bottom: 10px; color: #4CAF50; }
        #status { margin: 10px 0; padding: 10px; background: rgba(0,255,0,0.1); border-left: 3px solid #4CAF50; }
        #status.error { background: rgba(255,0,0,0.1); border-left-color: #f44336; }
        button { padding: 10px 20px; margin: 5px 0; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; }
        button:hover { background: #45a049; }
        button:disabled { background: #cccccc; cursor: not-allowed; }
        #debug-log { position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.9); padding: 15px; border-radius: 8px; font-size: 12px; font-family: monospace; max-height: 200px; overflow-y: auto; max-width: 500px; }
        . log-entry { margin: 3px 0; padding: 3px; }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-info { color: #2196F3; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <div id="info">
        <h2>VR メモアプリ - デバッグ版</h2>
        <div id="status" class="log-info">初期化中... </div>
        <button id="vrButton" disabled>VRモード開始</button>
        <button id="testButton">テストメモを配置</button>
        <button id="resetButton">リセット</button>
    </div>
    
    <div id="debug-log"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // デバッグログ
        const logs = [];
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const entry = `[${timestamp}] ${message}`;
            logs.push({ message: entry, type });
            
            const logDiv = document.getElementById('debug-log');
            const p = document.createElement('div');
            p.className = `log-entry log-${type}`;
            p.textContent = entry;
            logDiv.appendChild(p);
            logDiv.scrollTop = logDiv.scrollHeight;
            
            console.log(entry);
        }

        let scene, camera, renderer;
        let memos = [];
        let isInitialized = false;

        function init() {
            log('=== 初期化開始 ===', 'info');
            
            try {
                // Three.jsのチェック
                if (typeof THREE === 'undefined') {
                    throw new Error('Three.js が読み込まれていません！');
                }
                log('✓ Three.js v' + THREE. REVISION + ' 読み込み完了', 'success');

                // Canvas コンテナ
                const container = document.getElementById('canvas-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                log(`✓ Container: ${width}x${height}`, 'success');

                // Scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                log('✓ Scene 作成完了', 'success');

                // Camera
                camera = new THREE.PerspectiveCamera(75, width / height, 0. 1, 1000);
                camera.position.set(0, 1. 6, 5);
                log('✓ Camera 作成完了 (pos: 0, 1.6, 5)', 'success');

                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: false });
                renderer.setSize(width, height);
                renderer. setPixelRatio(window.devicePixelRatio);
                renderer.shadowMap.enabled = true;
                renderer.xr.enabled = true;
                container.appendChild(renderer.domElement);
                log('✓ Renderer 作成完了', 'success');

                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 1. 0);
                scene.add(ambientLight);
                log('✓ AmbientLight 追加', 'success');

                const directionalLight = new THREE.DirectionalLight(0xffffff, 1.2);
                directionalLight.position.set(10, 15, 10);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                log('✓ DirectionalLight 追加', 'success');

                // Floor
                const floorGeometry = new THREE.PlaneGeometry(100, 100);
                const floorMaterial = new THREE.MeshStandardMaterial({ color: 0x808080, roughness: 0.8 });
                const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                floor.rotation.x = -Math.PI / 2;
                scene.add(floor);
                log('✓ Floor 追加', 'success');

                // Test objects
                const sphereGeometry = new THREE.SphereGeometry(0.5, 32, 32);
                const sphereMaterial = new THREE.MeshStandardMaterial({ color: 0x0000ff });
                const sphere = new THREE. Mesh(sphereGeometry, sphereMaterial);
                sphere. position.set(0, 0. 5, -5);
                scene.add(sphere);
                log('✓ Blue Sphere 追加 (pos: 0, 0.5, -5)', 'success');

                const cubeGeometry = new THREE.BoxGeometry(1, 1, 1);
                const cubeMaterial1 = new THREE.MeshStandardMaterial({ color: 0xff0000 });
                const cube1 = new THREE.Mesh(cubeGeometry, cubeMaterial1);
                cube1. position.set(-3, 0.5, -5);
                scene.add(cube1);
                log('✓ Red Cube 追加 (pos: -3, 0.5, -5)', 'success');

                const cubeMaterial2 = new THREE. MeshStandardMaterial({ color: 0x00ff00 });
                const cube2 = new THREE.Mesh(cubeGeometry, cubeMaterial2);
                cube2. position.set(3, 0.5, -5);
                scene.add(cube2);
                log('✓ Green Cube 追加 (pos: 3, 0.5, -5)', 'success');

                // Event listeners
                document.getElementById('testButton').addEventListener('click', placeTestMemo);
                document.getElementById('resetButton').addEventListener('click', resetView);
                window.addEventListener('resize', onWindowResize);

                // Animation loop
                renderer.setAnimationLoop(animate);
                log('✓ アニメーションループ開始', 'success');

                isInitialized = true;
                updateStatus('✓ 初期化完了 - 青い球が見えるはずです');
                log('=== 初期化成功 ===', 'success');

            } catch (error) {
                log(`❌ エラー: ${error.message}`, 'error');
                updateStatus(`❌ エラー: ${error.message}`, true);
            }
        }

        function updateStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'log-error' : 'log-success';
        }

        function placeTestMemo() {
            if (!isInitialized) {
                log('❌ まだ初期化中です', 'error');
                return;
            }

            log('テストメモを配置中... ', 'info');

            const id = memos.length;
            const canvas = document.createElement('canvas');
            canvas.width = 512;
            canvas.height = 256;

            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#ffd93d';
            ctx.fillRect(0, 0, 512, 256);
            ctx.fillStyle = '#000';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(`テストメモ #${id + 1}`, 256, 128);

            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.SpriteMaterial({ map: texture });
            const sprite = new THREE.Sprite(material);
            sprite.position.set(
                (Math.random() - 0.5) * 10,
                1.5 + Math.random() * 2,
                -3 - Math.random() * 3
            );
            sprite.scale.set(2, 1, 1);
            scene.add(sprite);

            memos.push({ id, sprite });
            log(`✓ メモ配置完了 (合計: ${memos.length}個)`, 'success');
            updateStatus(`✓ メモ数: ${memos.length}`);
        }

        function resetView() {
            if (!camera) return;
            camera.position.set(0, 1.6, 5);
            camera.rotation.set(0, 0, 0);
            log('✓ ビューをリセット', 'success');
        }

        function onWindowResize() {
            const container = document.getElementById('canvas-container');
            const width = container. clientWidth;
            const height = container.clientHeight;
            
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
            log(`✓ リサイズ: ${width}x${height}`, 'info');
        }

        function animate() {
            if (renderer && camera && scene) {
                renderer.render(scene, camera);
            }
        }

        // 初期化開始
        window.addEventListener('load', init);
        
        // ページロード後に手動で初期化（念のため）
        if (document.readyState === 'complete') {
            init();
        }
    </script>
</body>
</html>
